# .github/workflows/build-upload-release.yml
name: Build and Upload to Published Release

# ç¯å¢ƒå˜é‡å®šä¹‰
env:
  APP_NAME: uploader          # åŸºç¡€åº”ç”¨åç§°
  PYTHON_VERSION: '3.10'      # å›ºå®šPythonç‰ˆæœ¬
  ENTRY_FILE: 'ui/app.py'     # ç¨‹åºå…¥å£æ–‡ä»¶

# è§¦å‘æ¡ä»¶ï¼šä»…å½“Releaseè¢«æ­£å¼å‘å¸ƒï¼ˆpublishedï¼‰æ—¶æ‰§è¡Œ
on:
  release:
    types: [published]

# å¤šå¹³å°æ„å»ºä»»åŠ¡
jobs:
  build-and-upload:
    # å¹¶è¡Œæ„å»ºLinux/Windows/macOSï¼Œä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false
    
    # è¿è¡Œç¯å¢ƒ
    runs-on: ${{ matrix.os }}
    
    # æ˜¾å¼å£°æ˜æƒé™ï¼ˆGitHub Actionsæœ€ä½³å®è·µï¼‰
    permissions:
      contents: write  # å…è®¸ä¸Šä¼ Releaseèµ„äº§
      actions: read    # å…è®¸è¯»å–Actionæ—¥å¿—

    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç ï¼ˆç»‘å®šåˆ°å½“å‰Releaseçš„Tagï¼‰
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}  # ç¡®ä¿ä»£ç ä¸Release Tagä¸€è‡´
          fetch-depth: 1                             # æµ…å…‹éš†åŠ é€Ÿ

      # æ­¥éª¤2ï¼šé…ç½®Pythonç¯å¢ƒï¼ˆå¸¦ç¼“å­˜ï¼‰
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # ç¼“å­˜pipä¾èµ–ï¼Œå¤§å¹…ç¼©çŸ­åç»­æ„å»ºæ—¶é—´

      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–ï¼ˆè·¨å¹³å°å…¼å®¹ï¼‰
      - name: Install dependencies (pip + pyinstaller)
        shell: bash  # Windowsä¸‹ç”±Git for Windowsæä¾›bash
        run: |
          # å‡çº§pipå¹¶å®‰è£…åŸºç¡€å·¥å…·
          python -m pip install --upgrade pip setuptools wheel
          
          # å®‰è£…æ‰“åŒ…å·¥å…·
          pip install pyinstaller
          
          # å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆå¦‚æœå­˜åœ¨requirements.txtï¼‰
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            echo "âœ… Installed project dependencies from requirements.txt"
          else
            echo "â„¹ï¸ No requirements.txt found, skip project dependencies"
          fi
          
          # æ‰“å°å·²å®‰è£…åŒ…åˆ—è¡¨ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
          pip list

      # æ­¥éª¤4ï¼šæ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¸¦è°ƒè¯•æ—¥å¿—ï¼‰
      - name: Build executable with PyInstaller
        shell: bash
        run: |
          # æ‰“å°ç³»ç»Ÿä¿¡æ¯
          echo "ğŸ” Build environment: $RUNNER_OS / $RUNNER_ARCH"
          python --version
          
          # æ‰§è¡ŒPyInstalleræ‰“åŒ…
          # --onefileï¼šå•æ–‡ä»¶æ‰“åŒ… | --windowedï¼šæ— æ§åˆ¶å°çª—å£ | --collect-all gradioï¼šå®Œæ•´æ‰“åŒ…gradioä¾èµ–
          pyinstaller \
            --onefile \
            --windowed \
            --collect-all gradio \
            -n ${{ env.APP_NAME }} \
            ${{ env.ENTRY_FILE }}
          
          # æ£€æŸ¥æ‰“åŒ…äº§ç‰©æ˜¯å¦å­˜åœ¨
          if [ -d "dist" ]; then
            ls -la dist/ || dir dist/  # å…¼å®¹Windows/macOS/Linuxçš„ç›®å½•æŸ¥çœ‹
            echo "âœ… Build completed, dist directory exists"
          else
            echo "âŒ Build failed, dist directory not found"
            exit 1
          fi

      # æ­¥éª¤5ï¼šé‡å‘½åäº§ç‰©ï¼ˆæŒ‰å¹³å°å·®å¼‚åŒ–å‘½åï¼‰
      - name: Rename executable for platform
        shell: bash
        run: |
          # å®šä¹‰ç›®æ ‡æ–‡ä»¶å
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            TARGET_FILE="uploader-linux"
            mv "dist/${{ env.APP_NAME }}" "./$TARGET_FILE"
            chmod +x "./$TARGET_FILE"  # å¢åŠ å¯æ‰§è¡Œæƒé™
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            TARGET_FILE="uploader-windows.exe"
            mv "dist/${{ env.APP_NAME }}.exe" "./$TARGET_FILE"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            TARGET_FILE="uploader-macos"
            mv "dist/${{ env.APP_NAME }}" "./$TARGET_FILE"
            chmod +x "./$TARGET_FILE"  # å¢åŠ å¯æ‰§è¡Œæƒé™
          fi
          
          # éªŒè¯é‡å‘½ååçš„æ–‡ä»¶
          if [ -f "./$TARGET_FILE" ]; then
            ls -la "./$TARGET_FILE" || dir "./$TARGET_FILE"
            echo "âœ… Renamed to $TARGET_FILE successfully"
          else
            echo "âŒ Failed to rename to $TARGET_FILE"
            exit 1
          fi

      # æ­¥éª¤6ï¼šä¸Šä¼ äº§ç‰©åˆ°Releaseï¼ˆä»…å½“æ–‡ä»¶å­˜åœ¨æ—¶æ‰§è¡Œï¼‰
      - name: Upload asset to GitHub Release
        uses: softprops/action-gh-release@v2
        if: |
          (runner.os == 'Linux' && exists('./uploader-linux')) ||
          (runner.os == 'Windows' && exists('./uploader-windows.exe')) ||
          (runner.os == 'macOS' && exists('./uploader-macos'))
        with:
          # ç»‘å®šåˆ°å½“å‰Releaseçš„Tag
          tag_name: ${{ github.event.release.tag_name }}
          # ä»…ä¸Šä¼ å½“å‰å¹³å°çš„äº§ç‰©
          files: |
            ${{ runner.os == 'Linux' && './uploader-linux' || 
               runner.os == 'Windows' && './uploader-windows.exe' || 
               './uploader-macos' }}
          # å¯é€‰ï¼šæ·»åŠ ä¸Šä¼ è¯´æ˜
          fail_on_unmatched_files: true  # æ–‡ä»¶ä¸å­˜åœ¨æ—¶ç›´æ¥å¤±è´¥
        env:
          # GitHubè‡ªåŠ¨ç”Ÿæˆçš„Tokenï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤7ï¼šæ„å»ºå¤±è´¥æ—¶æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
      - name: Debug info on failure
        if: failure()
        shell: bash
        run: |
          echo "âŒ Build failed, debug info:"
          echo "Runner OS: $RUNNER_OS"
          echo "Current directory: $(pwd)"
          ls -la || dir
          # æ‰“å°PyInstalleræ—¥å¿—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "pyinstaller.log" ]; then
            cat pyinstaller.log
          fi
