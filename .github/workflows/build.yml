# .github/workflows/build.yml
name: Build and Upload to Published Release

env:
  APP_NAME: uploader
  PYTHON_VERSION: '3.10'
  ENTRY_FILE: 'ui/app.py'

on:
  release:
    types: [published]

jobs:
  build-and-upload:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}
          fetch-depth: 1

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies (pip + pyinstaller)
        shell: bash
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            echo "‚úÖ Installed project dependencies"
          else
            echo "‚ÑπÔ∏è No requirements.txt found"
          fi
          pip list

      # Êñ∞Â¢ûÊ≠•È™§ÔºöÊü•ÊâæsafehttpxÁöÑÂÆâË£ÖË∑ØÂæÑÔºåÁî®‰∫éÊã∑Ë¥ùÈùôÊÄÅÊñá‰ª∂
      - name: Locate safehttpx and gradio static files
        shell: bash
        run: |
          # Ëé∑ÂèñsafehttpxÂÆâË£ÖÁõÆÂΩï
          SAFEHTTXP_PATH=$(python -c "import safehttpx; print(safehttpx.__path__[0])")
          echo "SAFEHTTXP_PATH=$SAFEHTTXP_PATH" >> $GITHUB_ENV
          # Ëé∑ÂèñgradioÂÆâË£ÖÁõÆÂΩï
          GRADIO_PATH=$(python -c "import gradio; print(gradio.__path__[0])")
          echo "GRADIO_PATH=$GRADIO_PATH" >> $GITHUB_ENV
          echo "üîç safehttpx path: $SAFEHTTXP_PATH"
          echo "üîç gradio path: $GRADIO_PATH"

      - name: Build executable with PyInstaller (fix static files)
        shell: bash
        run: |
          echo "üîç Build environment: $RUNNER_OS / $RUNNER_ARCH"
          python --version
          
          # Ê†∏ÂøÉ‰øÆÂ§çÔºöÈÄöËøá--add-data/--add-filesÂåÖÂê´Áº∫Â§±ÁöÑÈùôÊÄÅÊñá‰ª∂
          # Âå∫ÂàÜWindowsÂíåÁ±ªUnixÁ≥ªÁªüÁöÑË∑ØÂæÑÂàÜÈöîÁ¨¶
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            # Windows‰ΩøÁî®ÂàÜÂè∑ÂàÜÈöîÔºåË∑ØÂæÑÊ†ºÂºèÔºöÊ∫êË∑ØÂæÑ;ÁõÆÊ†áË∑ØÂæÑ
            ADD_DATA_SAFEHTTXP="--add-data=${{ env.SAFEHTTXP_PATH }}\\*;safehttpx\\"
            ADD_DATA_GRADIO="--add-data=${{ env.GRADIO_PATH }}\\templates\\*;gradio\\templates\\"
            ADD_DATA_GRADIO_STATIC="--add-data=${{ env.GRADIO_PATH }}\\static\\*;gradio\\static\\"
          else
            # Linux/macOS‰ΩøÁî®ÂÜíÂè∑ÂàÜÈöîÔºåË∑ØÂæÑÊ†ºÂºèÔºöÊ∫êË∑ØÂæÑ:ÁõÆÊ†áË∑ØÂæÑ
            ADD_DATA_SAFEHTTXP="--add-data=${{ env.SAFEHTTXP_PATH }}/*:safehttpx/"
            ADD_DATA_GRADIO="--add-data=${{ env.GRADIO_PATH }}/templates/*:gradio/templates/"
            ADD_DATA_GRADIO_STATIC="--add-data=${{ env.GRADIO_PATH }}/static/*:gradio/static/"
          fi
          
          # ÊâßË°åPyInstallerÊâìÂåÖÔºåÂåÖÂê´ÊâÄÊúâÁº∫Â§±ÁöÑÈùôÊÄÅÊñá‰ª∂
          pyinstaller \
            --onefile \
            --windowed \
            --collect-all gradio \
            --collect-all safehttpx \  # ÊòæÂºèÊî∂ÈõÜsafehttpxÊâÄÊúâ‰æùËµñ
            $ADD_DATA_SAFEHTTXP \      # Âº∫Âà∂ÂåÖÂê´safehttpxÁöÑÈùôÊÄÅÊñá‰ª∂ÔºàÂ¶Çversion.txtÔºâ
            $ADD_DATA_GRADIO \         # ÂåÖÂê´gradioÊ®°ÊùøÊñá‰ª∂
            $ADD_DATA_GRADIO_STATIC \  # ÂåÖÂê´gradioÈùôÊÄÅËµÑÊ∫ê
            -n ${{ env.APP_NAME }} \
            ${{ env.ENTRY_FILE }}
          
          # Ê£ÄÊü•ÊâìÂåÖ‰∫ßÁâ©
          if [ -d "dist" ]; then
            ls -la dist/ || dir dist/
            echo "‚úÖ Build completed"
          else
            echo "‚ùå Build failed, dist directory not found"
            exit 1
          fi

      - name: Rename executable for platform
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            TARGET_FILE="uploader-linux"
            mv "dist/${{ env.APP_NAME }}" "./$TARGET_FILE"
            chmod +x "./$TARGET_FILE"
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            TARGET_FILE="uploader-windows.exe"
            mv "dist/${{ env.APP_NAME }}.exe" "./$TARGET_FILE"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            TARGET_FILE="uploader-macos"
            mv "dist/${{ env.APP_NAME }}" "./$TARGET_FILE"
            chmod +x "./$TARGET_FILE"
          fi
          
          if [ -f "./$TARGET_FILE" ]; then
            ls -la "./$TARGET_FILE" || dir "./$TARGET_FILE"
            echo "FILE_EXISTS=true" >> $GITHUB_ENV
          else
            echo "‚ùå Failed to rename to $TARGET_FILE"
            echo "FILE_EXISTS=false" >> $GITHUB_ENV
            exit 1
          fi

      - name: Upload asset to GitHub Release
        uses: softprops/action-gh-release@v2
        if: env.FILE_EXISTS == 'true'
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            ${{ runner.os == 'Linux' && './uploader-linux' || 
               runner.os == 'Windows' && './uploader-windows.exe' || 
               './uploader-macos' }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug info on failure
        if: failure()
        shell: bash
        run: |
          echo "‚ùå Build failed, debug info:"
          echo "Runner OS: $RUNNER_OS"
          echo "Current directory: $(pwd)"
          ls -la || dir
          if [ -f "pyinstaller.log" ]; then
            cat pyinstaller.log
          fi
