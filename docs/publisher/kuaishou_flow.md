# 快手视频上传器工作流程

## 1. 项目概述

快手视频上传器是一个自动化工具，用于将视频上传到快手平台。它提供了完整的视频上传流程，包括视频上传、信息填写、封面设置、定时发布和最终发布等功能。

## 2. 核心类与结构

### 2.1 KuaiShouUploader 类

`KuaiShouUploader` 是上传器的核心类，继承自 `BaseUploader`，实现了快手平台的视频上传功能。

### 2.2 主要属性

| 属性名 | 类型 | 描述 |
|-------|------|------|
| platform_name | str | 平台名称（"kuaishou"） |
| login_url | str | 登录页面URL |
| login_success_url | str | 登录成功后的跳转URL |
| upload_url | str | 视频上传页面URL |
| success_url_pattern | str | 上传成功页面URL模式 |
| _login_selectors | List[str] | 登录相关元素选择器 |

## 3. 完整工作流程

### 3.1 主流程 (`upload_video_flow`)

`upload_video_flow` 是上传器的主要入口方法，协调整个视频上传流程：

```
1. 调用 verify_cookie_flow() 确保已登录
2. 初始化浏览器和上下文（无头模式）
3. 加载Cookie到浏览器上下文
4. 创建新页面并跳转到上传页面
5. 调用 _upload_video() 执行平台特定上传
6. 上传完成后清理资源
7. 返回上传结果
```

### 3.2 详细步骤分解

#### 3.2.1 认证验证

- **调用 verify_cookie_flow()**：确保已登录，如果未登录则根据auto_login参数决定是否执行登录
- **Cookie加载**：将保存的Cookie加载到浏览器上下文

#### 3.2.2 视频上传 (`_upload_video_file`)

- 定位视频上传按钮（`button[class^='_upload-btn']`）
- 等待并点击上传按钮
- 使用文件选择器设置视频文件路径
- 触发文件上传

#### 3.2.3 等待上传完成 (`_wait_for_upload_complete`)

- 使用多种方法检测上传状态：
  - 检查"上传中"文本是否消失
  - 检查视频信息编辑区域是否出现（`#work-description-edit`）
  - 检查上传成功标记是否出现（`div.upload-success`）
  - 检查发布按钮是否可见（`button.publish-btn:visible`）
- 最多等待60秒，前20秒每秒检查一次，之后每2秒检查一次
- 如超时，记录警告但继续后续操作

#### 3.2.4 填写视频信息 (`_fill_video_info`)

- **定位编辑区域**：点击视频信息编辑区域（`#work-description-edit`）
- **填写标题和描述**：
  - 组合标题和描述文本
  - 使用键盘输入标题和描述内容
- **添加标签**：
  - 清理标签格式（去除多余#号）
  - 使用shift+3组合键输入#号
  - 输入标签名称
  - 按回车键确认添加
  - 记录成功添加的标签数量

#### 3.2.5 设置视频封面 (`_set_thumbnail`)

- **检查封面文件**：验证封面文件是否存在
- **打开封面设置**：
  - 定位第二个"封面设置"按钮（`page.get_by_text("封面设置").nth(1)`）
  - 检查按钮是否可点击
  - 点击封面设置按钮
  - 等待封面设置模态框出现
- **上传封面图片**：
  - 定位并点击"上传封面"按钮
  - 等待文件输入框加载完成（使用attached状态）
  - 设置封面文件路径
- **确认封面设置**：
  - 定位确认按钮
  - 检查按钮是否可点击
  - 点击确认按钮
- **验证封面设置成功**：
  - 获取封面图片元素（第二个封面设置元素后的第一个img元素）
  - 记录原始图片URL
  - 等待图片URL发生变化
  - 如URL变化，确认封面设置成功

#### 3.2.6 设置定时发布 (`_set_schedule_time`)

- **打开定时发布设置**：点击"发布时间"选项下的定时发布单选按钮
- **设置发布时间**：
  - 定位日期时间选择器
  - 点击选择器打开日期时间选择面板
  - 全选当前时间
  - 输入格式化的发布时间（YYYY-MM-DD HH:MM:SS）
  - 按回车键确认设置

#### 3.2.7 发布视频 (`_publish_video`)

- **点击发布按钮**：定位并点击"发布"按钮
- **确认发布**：如果出现确认发布对话框，点击"确认发布"按钮
- **验证发布结果**：
  - 等待页面导航到成功页面
  - 检查当前URL是否包含成功标识
- **重试机制**：如果发布失败，重试发布操作

## 4. 技术特点

### 4.1 可靠性设计

- **多重选择器**：使用多个选择器尝试定位同一个元素，提高兼容性
- **超时保护**：为每个操作设置合理的超时时间，避免无限等待
- **错误处理**：捕获并处理各种异常，确保流程的连续性
- **状态验证**：使用多种方法验证操作结果

### 4.2 性能优化

- **异步操作**：使用asyncio实现异步执行，提高效率
- **动态等待时间**：根据不同阶段调整等待时间，减少不必要的等待
- **直接操作**：直接操作DOM元素，避免模拟复杂的用户交互

### 4.3 调试与监控

- **详细日志**：记录每个关键步骤的执行状态
- **截图功能**：在发布失败时自动截图，便于调试
- **进度跟踪**：实时记录上传进度和操作状态

## 5. 使用示例

```python
import asyncio
from pathlib import Path
from publisher.kuaishou_uploader import KuaiShouUploader

async def main():
    # 初始化上传器
    cookie_file_path = Path("cookies/kuaishou_uploader/account.json")
    uploader = KuaiShouUploader(cookie_file_path=cookie_file_path)

    # 确保已登录
    if not await uploader.verify_cookie_flow(auto_login=True):
        print("登录失败")
        return

    # 上传视频
    result = await uploader.upload_video_flow(
        file_path="video.mp4",
        title="我的视频",
        content="视频描述",
        tags=["标签1", "标签2"],
        thumbnail_path="cover.png",
        auto_login=True
    )

    if result:
        print("上传成功")
    else:
        print("上传失败")

asyncio.run(main())
```

## 6. 常见问题与解决方案

### 6.1 上传超时

**问题**：视频上传超过最大等待时间（60秒）

**解决方案**：
- 检查网络连接
- 检查视频文件大小和格式
- 增加最大等待时间（修改`_wait_for_upload_complete`方法中的`max_retries`参数）

### 6.2 元素定位失败

**问题**：无法定位某个页面元素

**解决方案**：
- 更新选择器（检查页面结构是否变化）
- 增加等待时间
- 添加更多备选选择器

### 6.3 标签添加失败

**问题**：无法成功添加标签

**解决方案**：
- 检查标签格式是否正确
- 增加标签输入后的等待时间
- 检查快手平台对标签的限制（数量、长度等）

### 6.4 封面设置失败

**问题**：封面图片上传成功但设置失败

**解决方案**：
- 检查封面图片格式和大小是否符合快手要求
- 增加封面设置后的等待时间
- 检查是否有弹出的确认对话框

### 6.5 发布超时

**问题**：点击发布按钮后等待超时

**解决方案**：
- 检查网络连接
- 增加超时时间
- 检查是否有弹出的确认对话框

## 7. 总结

快手视频上传器提供了完整的自动化上传流程，通过合理的设计和可靠的实现，确保了视频能够高效、稳定地上传到快手平台。它具有良好的扩展性和可维护性，可以根据平台的变化进行相应的调整和优化。
