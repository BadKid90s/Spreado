# 视频号视频上传器工作流程

## 1. 项目概述

视频号视频上传器是一个自动化工具，用于将视频上传到微信视频号平台。它提供了完整的视频上传流程，包括视频上传、信息填写、封面设置、定时发布、原创声明和最终发布等功能。

## 2. 核心类与结构

### 2.1 ShipinhaoUploader 类

`ShipinhaoUploader` 是上传器的核心类，继承自 `BaseUploader`，实现了视频号平台的视频上传功能。

### 2.2 主要属性

| 属性名 | 类型 | 描述 |
|-------|------|------|
| platform_name | str | 平台名称（"shipinhao"） |
| login_url | str | 登录页面URL |
| login_success_url | str | 登录成功后的跳转URL |
| upload_url | str | 视频上传页面URL |
| success_url_pattern | str | 上传成功页面URL模式 |
| _login_selectors | List[str] | 登录相关元素选择器列表 |

## 3. 完整工作流程

### 3.1 主流程 (`upload_video_flow`)

`upload_video_flow` 是上传器的主要入口方法，协调整个视频上传流程：

```
1. 调用 verify_cookie_flow() 确保已登录
2. 初始化浏览器和上下文（无头模式）
3. 加载Cookie到浏览器上下文
4. 创建新页面并跳转到上传页面
5. 调用 _upload_video() 执行平台特定上传
6. 上传完成后清理资源
7. 返回上传结果
```

### 3.2 详细步骤分解

#### 3.2.1 认证验证

- **调用 verify_cookie_flow()**：确保已登录，如果未登录则根据auto_login参数决定是否执行登录
- **Cookie加载**：将保存的Cookie加载到浏览器上下文

#### 3.2.2 打开上传页面

- 导航到视频号上传页面
- 等待页面加载完成
- 验证发布界面元素（`finder-card finder-card-flex`）可见

#### 3.2.3 视频上传 (`_upload_video_file`)

- 定位视频上传输入框（`div.upload input[type="file"][accept="video/*"][multiple="multiple"]`）
- 设置视频文件路径
- 触发文件上传
- 处理可能的上传错误

#### 3.2.4 等待上传完成 (`_wait_for_upload_complete`)

- 使用多种方法检测上传状态：
  - 检查上传状态标识
  - 检查视频预览是否出现
  - 检查进度条是否消失
- 设置300秒超时保护
- 如超时，记录错误并终止流程

#### 3.2.5 填写视频信息 (`_fill_video_info`)

- **填写标题**：
  - 定位标题输入框
  - 输入视频标题
- **填写描述**：
  - 定位描述编辑区域
  - 输入视频描述内容
- **添加标签**：
  - 清理标签格式
  - 依次添加每个标签
  - 按回车键确认每个标签

#### 3.2.6 设置视频封面 (`_set_thumbnail`)

- **检查封面文件**：验证封面文件是否存在
- **打开封面设置**：
  - 点击个人主页卡片（`div.tips-wrap:has(div.cover-tips:has-text("个人主页卡片"))`）
  - 等待模态框出现
- **上传封面图片**：
  - 定位文件输入框（`div.single-cover-uploader-wrap input[type="file"][accept="image/jpeg,image/jpg,image/png"]`）
  - 上传封面图片
  - 等待裁剪对话框出现
- **确认封面设置**：
  - 点击确认按钮（`div.weui-desktop-dialog__wrp:has(h3:has-text("裁剪封面图")) div.weui-desktop-dialog__ft button:has-text("确认")`）
  - 等待模态框关闭
  - 验证封面图片URL变化

#### 3.2.7 添加到合集 (`_add_collection`)

- 定位合集选择器
- 选择合适的合集
- 如无合集或操作失败，记录信息但继续流程

#### 3.2.8 设置原创声明 (`_add_original`)

- 定位原创声明相关元素
- 点击原创声明选项
- 设置视频分类（可选）
- 确认原创声明设置

#### 3.2.9 设置定时发布 (`_set_schedule_time`)

- 点击定时发布选项
- 定位日期和时间选择器
- 设置发布日期和时间
- 格式化时间为"HH:MM"格式
- 确认定时发布设置

#### 3.2.10 添加短标题 (`_add_short_title`)

- 定位短标题输入框
- 根据原标题格式化生成短标题（限制16字符内）
- 输入短标题

#### 3.2.11 发布视频 (`_publish_video`)

- 根据参数选择发布或保存草稿
- **保存草稿**：
  - 点击"保存草稿"按钮
  - 等待页面导航到草稿列表
- **发布视频**：
  - 点击"发表"按钮
  - 等待页面导航到成功页面
- 设置最大重试次数（10次）
- 验证发布结果

## 4. 技术特点

### 4.1 可靠性设计

- **错误处理**：每个步骤都有完善的错误处理机制
- **超时保护**：为每个操作设置合理的超时时间
- **状态验证**：使用多种方法验证操作结果
- **返回值检查**：每个子方法返回bool值，便于主流程控制

### 4.2 性能优化

- **异步操作**：使用asyncio实现异步执行，提高效率
- **精确等待**：只等待必要的元素和状态
- **直接操作**：直接操作DOM元素，避免模拟复杂的用户交互

### 4.3 调试与监控

- **详细日志**：记录每个关键步骤的执行状态
- **导航跟踪**：记录所有页面导航URL
- **错误日志**：详细记录每个步骤的错误信息

## 5. 通用工具方法

### 5.1 _format_str_for_short_title

格式化视频标题为短标题：

- **参数**：
  - `origin_title`：原始标题
- **返回值**：格式化后的短标题
- **规则**：
  - 允许的特殊字符：`《》“”:+?%°`
  - 长度限制：6-16个字符
  - 超出长度自动截断
  - 不足长度自动补空格

## 6. 使用示例

```python
import asyncio
from pathlib import Path
from publisher.shipinhao_uploader import ShipinhaoUploader

async def main():
    # 初始化上传器
    cookie_file_path = Path("cookies/shipinhao_uploader/account.json")
    uploader = ShipinhaoUploader(cookie_file_path=cookie_file_path)

    # 确保已登录
    if not await uploader.verify_cookie_flow(auto_login=True):
        print("登录失败")
        return

    # 上传视频
    result = await uploader.upload_video_flow(
        file_path="video.mp4",
        title="我的视频",
        content="视频描述",
        tags=["标签1", "标签2"],
        thumbnail_path="cover.png",
        auto_login=True
    )

    if result:
        print("上传成功")
    else:
        print("上传失败")

asyncio.run(main())
```

## 7. 常见问题与解决方案

### 7.1 上传超时

**问题**：视频上传超过最大等待时间（300秒）

**解决方案**：
- 检查网络连接
- 检查视频文件大小和格式
- 增加最大等待时间（修改`_wait_for_upload_complete`方法中的超时参数）

### 7.2 元素定位失败

**问题**：无法定位某个页面元素

**解决方案**：
- 更新选择器（检查页面结构是否变化）
- 增加等待时间
- 添加更多备选选择器

### 7.3 发布超时

**问题**：点击发布按钮后等待超时

**解决方案**：
- 检查网络连接
- 增加超时时间
- 检查是否有弹出的确认对话框

### 7.4 封面设置失败

**问题**：无法设置视频封面

**解决方案**：
- 检查封面文件是否存在
- 检查封面文件格式是否支持（PNG、JPEG、JPG等）
- 增加封面设置步骤的等待时间
- 确保使用正确的选择器定位确认按钮

### 7.5 定时发布设置失败

**问题**：无法设置定时发布时间

**解决方案**：
- 检查日期格式是否正确
- 确保选择了有效的日期
- 检查时间格式是否为"HH:MM"

## 8. 平台特有要求与注意事项

### 8.1 视频格式要求

- 支持的视频格式：MP4、MOV等
- 视频时长：15秒 - 15分钟
- 视频分辨率：建议不低于720p
- 视频大小：建议不超过1GB

### 8.2 封面要求

- 支持的图片格式：PNG、JPEG、JPG
- 图片尺寸：建议1080x1440（3:4比例）
- 图片大小：建议不超过5MB

### 8.3 内容要求

- 标题：不超过60个字符
- 短标题：6-16个字符，支持有限的特殊字符
- 描述：不超过2000个字符
- 标签：最多添加10个标签

### 8.4 发布规则

- 原创声明：支持设置原创声明和分类
- 定时发布：支持设置未来7天内的发布时间
- 合集：支持添加到已有合集
- 草稿：支持保存为草稿

## 9. 与抖音上传流程对比

| 流程步骤 | 抖音 | 视频号 |
|---------|------|--------|
| 登录方式 | 创作者平台登录 | 视频号后台登录 |
| 封面设置 | 直接上传或选择帧 | 需点击个人主页卡片，支持裁剪 |
| 短标题 | 无 | 必须，6-16字符 |
| 原创声明 | 无 | 支持，需选择分类 |
| 合集功能 | 有 | 有 |
| 定时发布 | 支持 | 支持未来7天 |
| 商品链接 | 支持 | 需额外配置 |
| 第三方同步 | 支持 | 无 |

## 10. 总结

视频号视频上传器提供了完整的自动化上传流程，通过合理的设计和可靠的实现，确保了视频能够高效、稳定地上传到视频号平台。它具有良好的扩展性和可维护性，可以根据平台的变化进行相应的调整和优化。