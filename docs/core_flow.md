# 多平台视频上传工具执行流程梳理

## 1. 有头模式登录流程
- **模式**: 有头模式 (headless=False)
- **目的**: 登录账号保存Cookie
- **流程**:
    1. 初始化StealthBrowser实例（有头模式）
    2. 创建新页面并访问登录页面
    3. 打开浏览器让用户手动登录
    4. 使用 `page.wait_for_url()` 监听页面是否跳转到登录成功URL
    5. 登录成功后保存Cookie到账户文件
    6. 清理资源并返回结果

## 2. 无头模式验证Cookie流程
- **模式**: 无头模式 (headless=True)
- **目的**: 验证Cookie是否有效
- **流程**:
    1. 检查Cookie文件是否存在
    2. 初始化StealthBrowser实例（无头模式）
    3. 加载Cookie到浏览器上下文
    4. 访问上传页面
    5. 检查页面上是否有登录相关元素（通过 `_login_selectors` 定义的选择器）
    6. 如果有登录元素，说明Cookie失效，返回验证失败
    7. 如果没有登录元素，说明Cookie有效，返回验证成功
    8. 清理资源

## 3. 主上传流程
- **模式**: 无头模式 (headless=True)
- **目的**: 执行视频上传
- **流程**:
    1. 调用 `verify_cookie_flow()` 确保已登录
    2. 如果未登录且允许自动登录，则执行登录流程
    3. 初始化StealthBrowser实例（无头模式）
    4. 加载Cookie到浏览器上下文
    5. 创建新页面并跳转到上传页面
    6. 调用平台特定的 `_upload_video()` 方法执行上传
    7. 上传完成后清理资源
    8. 返回上传结果

## 4. 平台特定上传流程
- **目的**: 执行具体平台的视频上传
- **流程**:
    1. 跳转到上传页面
    2. 上传视频文件
    3. 等待上传完成
    4. 填写视频信息（标题、描述、标签）
    5. 设置封面（如有）
    6. 设置定时发布（如有）
    7. 点击发布按钮
    8. 验证发布结果
    9. 返回上传成功/失败状态

## 5. 主认证流程（verify_cookie_flow）
- **目的**: 统一协调认证相关流程
- **流程**:
    1. 检查Cookie文件是否存在
    2. 如果不存在且允许自动登录，则执行登录流程
    3. 如果存在，执行Cookie验证流程
    4. 如果Cookie验证失败且允许自动登录，则执行登录流程
    5. 如果Cookie验证成功，返回已登录状态

## 6. 流程间关系
- **主上传流程** → **主认证流程**：开始上传前确保已登录
- **主认证流程** → **有头模式登录流程**：Cookie文件不存在或验证失败时
- **主认证流程** → **无头模式验证Cookie流程**：Cookie文件存在时
- **主上传流程** → **平台特定上传流程**：认证成功后执行上传

## 7. 开发调试建议
- **开发阶段可以使用有头模式**:
    - 方便排查错误
    - 进行调试
    - 观察实际操作流程
- **生产环境推荐使用无头模式**:
    - 提高执行效率
    - 减少资源占用
    - 适合批量操作